openapi: 3.1.0
info:
  title: VaulTLS API
  description: |
    VaulTLS is a self-hosted web application for managing mTLS certificates.
    
    This API allows you to:
    - Manage certificates and certificate authorities
    - Create and manage users
    - Configure application settings
    - Automate certificate lifecycle management
    
    ## Authentication
    
    VaulTLS supports two authentication methods:
    
    ### Session Authentication (Web UI)
    Used by the web interface with HTTP-only cookies containing JWT tokens.
    
    ### Bearer Token Authentication (API Automation) ðŸš€
    **Recommended for API automation.** Uses Bearer tokens with fine-grained scopes.
    
    ```
    Authorization: Bearer vlt_abc123_<token-value>
    ```
    
    See the [Authentication Guide](https://github.com/7ritn/VaulTLS/blob/main/docs/api/authentication.md) for detailed examples.
    
    ## Rate Limiting
    
    - Default: 100 requests/minute per IP
    - Authenticated: 1000 requests/minute
    - Bearer tokens: Configurable per token
    
    ## Error Handling

    All errors follow RFC 9457 Problem Details format with `application/problem+json` content type:

    ```json
    {
      "type": "https://tools.ietf.org/html/rfc9110#section-15.5.2",
      "title": "Unauthorized",
      "status": 401,
      "detail": "Bearer token is missing or invalid",
      "instance": "/api/certificates"
    }
    ```

    ## Documentation

    - **RapiDoc (Interactive)**: `/api-docs` - Try API endpoints directly
    - **Redoc (Reference)**: `/redoc` - Clean, comprehensive documentation
    - **OpenAPI Spec**: `/api/openapi.json` - Machine-readable specification
  version: 1.0.0
  contact:
    name: VaulTLS
    url: https://github.com/7ritn/VaulTLS
  license:
    name: MIT
    url: https://github.com/7ritn/VaulTLS/blob/main/LICENSE

servers:
  - url: https://vaultls.example.com/api
    description: Production server
  - url: http://localhost:5173/api
    description: Development server

security:
  - BearerAuth: []
  - SessionAuth: []

paths:
  /server/version:
    get:
      tags: [Server]
      summary: Get server version
      description: Returns the current VaulTLS server version
      security: []
      responses:
        '200':
          description: Server version
          content:
            text/plain:
              schema:
                type: string
                example: "1.0.0"

  # ===== ENHANCED CERTIFICATE MANAGEMENT =====

  /certificates/search:
    post:
      tags: [Certificates]
      summary: Advanced certificate search
      description: |
        Search certificates with advanced filters and operators.

        Supports 17 searchable fields and 13 operators for complex queries.
      security:
        - BearerAuth: [cert.read]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                filters:
                  type: array
                  items:
                    type: object
                    properties:
                      field:
                        type: string
                        enum: [name, commonName, serialNumber, issuer, subject, status, certificateType, algorithm, keySize, createdAt, validUntil, revokedAt, sans, profileId, caId, userId, metadata]
                      operator:
                        type: string
                        enum: [eq, ne, lt, lte, gt, gte, like, in, nin, between, contains, startsWith, endsWith]
                      value:
                        oneOf:
                          - type: string
                          - type: number
                          - type: boolean
                          - type: array
                            items:
                              type: string
                          - type: object
                            properties:
                              start:
                                type: number
                              end:
                                type: number
                sort:
                  type: array
                  items:
                    type: object
                    properties:
                      field:
                        type: string
                        enum: [name, commonName, serialNumber, issuer, subject, status, certificateType, algorithm, keySize, createdAt, validUntil, revokedAt, sans, profileId, caId, userId, metadata]
                      direction:
                        type: string
                        enum: [asc, desc]
                page:
                  type: integer
                  minimum: 1
                  default: 1
                per_page:
                  type: integer
                  minimum: 1
                  maximum: 100
                  default: 20
                include_revoked:
                  type: boolean
                  default: true
                include_expired:
                  type: boolean
                  default: true
            examples:
              basic_search:
                summary: Basic search by status
                value:
                  filters:
                    - field: status
                      operator: eq
                      value: active
                  page: 1
                  per_page: 20
              advanced_search:
                summary: Advanced search with multiple filters
                value:
                  filters:
                    - field: status
                      operator: eq
                      value: active
                    - field: valid_until
                      operator: between
                      value:
                        start: 1640995200
                        end: 1672531200
                    - field: sans
                      operator: contains
                      value: example.com
                  sort:
                    - field: valid_until
                      direction: asc
                    - field: created_at
                      direction: desc
                  page: 1
                  per_page: 50
                  include_revoked: false
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  certificates:
                    type: array
                    items:
                      $ref: '#/components/schemas/Certificate'
                  total:
                    type: integer
                  page:
                    type: integer
                  per_page:
                    type: integer
                  has_more:
                    type: boolean
                  filters_applied:
                    type: array
                  sort_applied:
                    type: array
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /certificates/batch:
    post:
      tags: [Certificates]
      summary: Batch certificate operations
      description: |
        Perform bulk operations on multiple certificates.

        Supported operations: revoke, restore, delete, download, renew, updateMetadata
      security:
        - BearerAuth: [cert.write]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [certificate_ids, operation]
              properties:
                certificate_ids:
                  type: array
                  items:
                    type: integer
                  minItems: 1
                  maxItems: 100
                operation:
                  type: string
                  enum: [revoke, restore, delete, download, renew, updateMetadata]
                parameters:
                  type: object
                  properties:
                    revocation_reason:
                      type: integer
                      description: RFC 5280 revocation reason code
                    revocation_note:
                      type: string
                    format:
                      type: string
                      enum: [pem, der, p12]
                    include_chain:
                      type: boolean
                    validity_years:
                      type: integer
                      minimum: 1
                      maximum: 10
                    metadata:
                      type: object
            examples:
              bulk_revoke:
                summary: Bulk revoke certificates
                value:
                  certificate_ids: [1, 2, 3, 4, 5]
                  operation: revoke
                  parameters:
                    revocation_reason: 1
                    revocation_note: "Security incident response"
              bulk_download:
                summary: Bulk download certificates
                value:
                  certificate_ids: [10, 11, 12]
                  operation: download
                  parameters:
                    format: pem
                    include_chain: true
      responses:
        '200':
          description: Batch operation results
          content:
            application/json:
              schema:
                type: object
                properties:
                  operation:
                    type: string
                  total_requested:
                    type: integer
                  successful:
                    type: integer
                  failed:
                    type: integer
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        certificate_id:
                          type: integer
                        success:
                          type: boolean
                        error:
                          type: string
                        details:
                          type: string
                  download_url:
                    type: string
                    description: Present for download operations
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /server/setup:
    get:
      tags: [Server]
      summary: Check setup status
      description: Check if the server has been set up
      security: []
      responses:
        '200':
          description: Setup status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SetupStatus'
    
    post:
      tags: [Server]
      summary: Initial server setup
      description: Perform initial server setup (only possible if not already set up)
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetupRequest'
      responses:
        '204':
          description: Setup completed successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Server already set up

  /auth/login:
    post:
      tags: [Authentication]
      summary: Login with email and password
      description: Authenticate user and create session cookie
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '204':
          description: Login successful, session cookie set
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/logout:
    post:
      tags: [Authentication]
      summary: Logout current session
      description: Clear authentication session
      responses:
        '204':
          description: Logout successful

  /auth/oidc/login:
    get:
      tags: [Authentication]
      summary: Initiate OIDC login
      description: Redirect to OIDC provider for authentication
      security: []
      responses:
        '302':
          description: Redirect to OIDC provider
        '400':
          description: OIDC not configured

  /certificates:
    get:
      tags: [Certificates]
      summary: List certificates
      description: Get list of certificates (users see only their own)
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: List of certificates
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Certificate'
        '401':
          $ref: '#/components/responses/Unauthorized'
    
    post:
      tags: [Certificates]
      summary: Create new certificate
      description: Create a new certificate (admin only)
      security:
        - BearerAuth: [cert.write]
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCertificateRequest'
      responses:
        '201':
          description: Certificate created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Certificate'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /certificates/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
        description: Certificate ID
    
    get:
      tags: [Certificates]
      summary: Get certificate details
      description: Get detailed information about a specific certificate
      security:
        - BearerAuth: [cert.read]
        - SessionAuth: []
      responses:
        '200':
          description: Certificate details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Certificate'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags: [Certificates]
      summary: Delete certificate
      description: Delete a certificate (admin only)
      security:
        - BearerAuth: [cert.write]
        - SessionAuth: []
      responses:
        '204':
          description: Certificate deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /certificates/{id}/download:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
        description: Certificate ID
    
    get:
      tags: [Certificates]
      summary: Download certificate
      description: Download certificate in specified format
      security:
        - BearerAuth: [cert.download]
        - SessionAuth: []
      parameters:
        - name: format
          in: query
          schema:
            type: string
            enum: [pkcs12, pem, der]
            default: pkcs12
          description: Certificate format
      responses:
        '200':
          description: Certificate file
          content:
            application/x-pkcs12:
              schema:
                type: string
                format: binary
            application/x-pem-file:
              schema:
                type: string
                format: binary
            application/x-x509-ca-cert:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /certificates/{id}/password:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
        description: Certificate ID
    
    get:
      tags: [Certificates]
      summary: Get certificate password
      description: Get the PKCS#12 password for a certificate
      security:
        - BearerAuth: [cert.read]
        - SessionAuth: []
      responses:
        '200':
          description: Certificate password
          content:
            application/json:
              schema:
                type: object
                properties:
                  password:
                    type: string
                    description: PKCS#12 password
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /certificates/ca/download:
    get:
      tags: [Certificate Authority]
      summary: Download CA certificate
      description: Download the Certificate Authority certificate
      security: []
      parameters:
        - name: format
          in: query
          schema:
            type: string
            enum: [pem, der, cer]
            default: pem
          description: Certificate format
      responses:
        '200':
          description: CA certificate file
          content:
            application/x-pem-file:
              schema:
                type: string
                format: binary
            application/x-x509-ca-cert:
              schema:
                type: string
                format: binary

components:
  schemas:
    Certificate:
      type: object
      properties:
        id:
          type: integer
          example: 123
        name:
          type: string
          example: "web-server-cert"
        created_on:
          type: integer
          format: int64
          description: Unix timestamp
          example: 1640995200
        valid_until:
          type: integer
          format: int64
          description: Unix timestamp
          example: 1672531200
        certificate_type:
          type: string
          enum: [Server, Client]
          example: "Server"
        user_id:
          type: integer
          example: 1
        tenant_id:
          type: string
          example: "tenant_123"
        profile_id:
          type: string
          example: "profile_456"
        serial_number:
          type: string
          example: "1A:2B:3C:4D:5E:6F"
        issuer:
          type: string
          example: "CN=VaulTLS CA,O=Example Corp"
        subject:
          type: string
          example: "CN=web.example.com,O=Example Corp"
        algorithm:
          type: string
          example: "RSA-2048"
        key_size:
          type: integer
          example: 2048
        sans:
          type: string
          description: JSON string of Subject Alternative Names
          example: '{"dns_names":["web.example.com","api.example.com"]}'
        metadata:
          type: string
          description: JSON string of additional metadata
          example: '{"department":"IT","environment":"production"}'
        status:
          type: string
          enum: [active, revoked, expired]
          example: "active"
        ca_id:
          type: integer
          example: 1
        revoked_at:
          type: integer
          format: int64
          nullable: true
        revoked_by_user_id:
          type: integer
          nullable: true
        revocation_reason:
          type: integer
          nullable: true

    ProblemDetails:
      type: object
      description: RFC 9457 Problem Details for HTTP APIs
      required: [type, title, status]
      properties:
        type:
          type: string
          format: uri
          description: URI reference that identifies the problem type
          example: "https://tools.ietf.org/html/rfc9110#section-15.5.2"
        title:
          type: string
          description: Short, human-readable summary of the problem type
          example: "Unauthorized"
        status:
          type: integer
          description: HTTP status code
          example: 401
        detail:
          type: string
          description: Human-readable explanation specific to this occurrence
          example: "Bearer token is missing or invalid"
        instance:
          type: string
          format: uri
          description: URI reference that identifies the specific occurrence
          example: "/api/certificates"

  responses:
    BadRequest:
      description: Bad Request - Invalid input parameters
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://tools.ietf.org/html/rfc9110#section-15.5.1"
            title: "Bad Request"
            status: 400
            detail: "Invalid search filter: field 'invalid_field' is not supported"
            instance: "/api/certificates/search"

    Unauthorized:
      description: Unauthorized - Authentication failed
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://tools.ietf.org/html/rfc9110#section-15.5.2"
            title: "Unauthorized"
            status: 401
            detail: "Bearer token is missing or invalid"
            instance: "/api/certificates"

    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://tools.ietf.org/html/rfc9110#section-15.5.4"
            title: "Forbidden"
            status: 403
            detail: "Token missing required scope: cert.write"
            instance: "/api/certificates/batch"

    NotFound:
      description: Not Found - Resource not found
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://tools.ietf.org/html/rfc9110#section-15.5.5"
            title: "Not Found"
            status: 404
            detail: "Certificate with ID 123 not found"
            instance: "/api/certificates/123"

    Conflict:
      description: Conflict - Resource conflict
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://tools.ietf.org/html/rfc9110#section-15.5.10"
            title: "Conflict"
            status: 409
            detail: "Certificate profile 'server-profile' already exists"
            instance: "/api/profiles"

    TooManyRequests:
      description: Too Many Requests - Rate limit exceeded
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://tools.ietf.org/html/rfc6585#section-4"
            title: "Too Many Requests"
            status: 429
            detail: "Rate limit of 100 requests per minute exceeded"
            instance: "/api/certificates"

    InternalServerError:
      description: Internal Server Error
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://tools.ietf.org/html/rfc9110#section-15.6.1"
            title: "Internal Server Error"
            status: 500
            detail: "An unexpected error occurred"
            instance: "/api/certificates"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: "vlt_xxxxxx_<token>"
      description: |
        Bearer token authentication for API automation.
        
        Format: `vlt_<6-char-prefix>_<base64url-token-value>`
        
        Example: `vlt_abc123_dGVzdF90b2tlbl92YWx1ZQ`
        
        Supports fine-grained permissions through scopes:

        **Certificate Management:**
        - `cert.read` - View certificates and search
        - `cert.write` - Create, update, and batch operations
        - `cert.revoke` - Revoke and restore certificates
        - `cert.download` - Download certificates and chains

        **Certificate Authority Management:**
        - `ca.read` - View CAs and their details
        - `ca.write` - Create, update, and delete CAs
        - `ca.keyop` - Key operations (rotation, signing)

        **Certificate Profiles:**
        - `profile.read` - View certificate profiles
        - `profile.write` - Create, update, and delete profiles

        **API Token Management:**
        - `token.read` - View API tokens
        - `token.write` - Create, update, and rotate tokens
        - `token.admin` - Full token management including revocation

        **Audit and Monitoring:**
        - `audit.read` - View audit logs and reports
        - `metrics.read` - View system metrics and statistics

        **Administrative:**
        - `admin.tenant` - Tenant-level administrative operations
    
    SessionAuth:
      type: apiKey
      in: cookie
      name: auth_token
      description: |
        Session-based authentication using HTTP-only cookies.
        Used by the web interface. Not recommended for API automation.

  parameters:
    Page:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
      description: Page number (1-based)
    
    Limit:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 50
      description: Number of items per page

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://vaultls.example.com/errors/bad-request"
            title: "Bad Request"
            status: 400
            detail: "Invalid certificate type specified"
            instance: "/api/certificates"
    
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://vaultls.example.com/errors/unauthorized"
            title: "Authentication Required"
            status: 401
            detail: "Bearer token is missing or invalid"
            instance: "/api/certificates"
    
    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://vaultls.example.com/errors/forbidden"
            title: "Insufficient Permissions"
            status: 403
            detail: "Token missing required scope: cert.write"
            instance: "/api/certificates"
    
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://vaultls.example.com/errors/not-found"
            title: "Resource Not Found"
            status: 404
            detail: "Certificate with ID 123 not found"
            instance: "/api/certificates/123"

  schemas:
    ProblemDetails:
      type: object
      description: RFC 7807 Problem Details for HTTP APIs
      properties:
        type:
          type: string
          format: uri
          description: URI identifying the problem type
        title:
          type: string
          description: Short, human-readable summary
        status:
          type: integer
          description: HTTP status code
        detail:
          type: string
          description: Human-readable explanation
        instance:
          type: string
          format: uri
          description: URI identifying the specific occurrence
      required: [type, title, status]

    SetupStatus:
      type: object
      properties:
        setup:
          type: boolean
          description: Whether the server has been set up
        password:
          type: boolean
          description: Whether password authentication is enabled
        oidc:
          type: string
          description: OIDC configuration status
          enum: [configured, not_configured, error]
      required: [setup, password, oidc]

    SetupRequest:
      type: object
      properties:
        name:
          type: string
          description: Administrator name
          example: "Admin User"
        email:
          type: string
          format: email
          description: Administrator email
          example: "admin@example.com"
        password:
          type: string
          description: Administrator password (optional if OIDC configured)
          example: "secure-password"
      required: [name, email]

    LoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
          description: User email address
          example: "user@example.com"
        password:
          type: string
          description: User password
          example: "password"
      required: [email, password]

    Certificate:
      type: object
      properties:
        id:
          type: integer
          description: Certificate ID
          example: 1
        name:
          type: string
          description: Certificate name
          example: "api.example.com"
        created_on:
          type: integer
          description: Creation timestamp (Unix)
          example: 1640995200
        valid_until:
          type: integer
          description: Expiration timestamp (Unix)
          example: 1672531200
        certificate_type:
          type: string
          enum: [server, client]
          description: Certificate type
          example: "server"
        user_id:
          type: integer
          description: Owner user ID
          example: 1
        renew_method:
          type: string
          enum: [manual, automatic]
          description: Renewal method
          example: "manual"
      required: [id, name, created_on, valid_until, certificate_type, user_id, renew_method]

    CreateCertificateRequest:
      type: object
      properties:
        name:
          type: string
          description: Certificate name
          example: "api.example.com"
        certificate_type:
          type: string
          enum: [server, client]
          description: Certificate type
          example: "server"
        dns_names:
          type: array
          items:
            type: string
          description: DNS Subject Alternative Names
          example: ["api.example.com", "www.api.example.com"]
        ip_addresses:
          type: array
          items:
            type: string
          description: IP Subject Alternative Names
          example: ["192.168.1.100"]
        email_addresses:
          type: array
          items:
            type: string
          description: Email Subject Alternative Names
          example: []
        validity_days:
          type: integer
          minimum: 1
          maximum: 3650
          description: Certificate validity period in days
          example: 365
        key_algorithm:
          type: string
          enum: [rsa-2048, rsa-3072, rsa-4096, ecdsa-p256, ecdsa-p384]
          description: Key algorithm and size
          example: "ecdsa-p256"
      required: [name, certificate_type]

tags:
  - name: Server
    description: Server information and setup
  - name: Authentication
    description: User authentication and session management
  - name: Certificates
    description: Certificate management operations
  - name: Certificate Authority
    description: Certificate Authority operations
  - name: Users
    description: User management (admin only)
  - name: Settings
    description: Application settings (admin only)
